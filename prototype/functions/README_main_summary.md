# main.py の全体処理まとめ

このドキュメントは `prototype/local_cli/main.py` の主要な処理フロー・役割を一つにまとめて分かりやすく解説します。

---

## 概要

- Jira APIからスプリント・課題データを取得し、ダッシュボード画像（sprint_overview.png）を自動生成するメインスクリプトです。
- 画像には進捗バーンダウン、ベロシティ、KPI、リスク、エビデンス（重要課題）、AI要約などを可視化します。
- 取得したデータはMarkdown/JSONでも出力され、Slack連携等にも利用可能です。

---

## 主な処理フロー

1. **環境変数・認証情報の読み込み**

   - .envファイルからJira認証情報や各種設定値を取得。

2. **Jira API認証・ボード/スプリント情報の解決**

   - プロジェクト・ボード・アクティブスプリントのIDや期間を特定。
   - スプリント運用のできないボード（例: カンバン）を除外し、アクティブスプリントが存在するスクラムボードを自動選択。

3. **各種集計スクリプトの実行**

   - サブタスク一覧・バーンダウン・ベロシティ・ステータス分布・工程滞在時間・担当者ワークロード・KPI・リスク・エビデンス等を取得。
   - 取得は queries/ 配下のPythonスクリプトをサブプロセスで呼び出し、JSONで受け取る。
   - 課題検索は Jira の `/rest/api/3/search/jql` エンドポイントを利用し、`pageToken` を使ったページネーションで全件取得。
   - `/search/jql` はレスポンスに `total` を返さないため、繰り返し呼び出して件数を積み上げる実装に統一。

4. **ダッシュボード画像の生成**

   - PIL(Pillow)で白背景のキャンバスを作成。
   - 進捗バー、ベロシティ履歴、KPIカード、リスク、エビデンステーブル、AI要約パネル等を描画。
   - レイアウト・色・ラベルは日本語で分かりやすく設計。

5. **AI要約（Gemini API）**

   - 進捗やリスク、エビデンスの理由をAIで要約し、画像やMarkdownに反映。

6. **Markdown/JSONレポート出力**

   - 画像と同時に、進捗・リスク・エビデンス等の要約をMarkdown/JSONで出力。
   - Slack連携や外部分析にも利用可能。

7. **ログ出力（DASHBOARD_LOG有効時）**
   - 取得データや主要指標を標準出力にサマリー表示。

---

## 主要な可視化要素

- スプリント進捗バーンダウン（未完了タスク推移）
- ベロシティ履歴（過去スプリントの完了ポイント）
- KPIカード（未完了数・期限・優先度等）
- リスク（期限超過・高優先度未着手等）
- 重要エビデンス（滞留・期限・優先度で抽出）
- AI要約（Geminiによる進捗・リスク・アクション提案）

---

## 使い方

1. .envにJira認証情報をセット
2. main.pyを実行（python -X utf8 prototype/local_cli/main.py）
3. sprint_overview.png, sprint_overview_report.md, sprint_overview_data.json などが自動生成されます

---

## 備考

- 画像レイアウトや取得項目は.envやコマンド引数で柔軟にカスタマイズ可能
- 取得失敗時はエラーログを出力し、可能な限り処理継続
- `/rest/api/3/search/jql` は 2024年以降の公式推奨エンドポイント。旧 `/search` は廃止済みのため利用しないこと。
- `pageToken` ベースのページネーションを実装しているため、大量データでも取りこぼしなく集計可能。

---

## Jira API 更新ポイント（2024年 Q4）

- 旧 `/rest/api/3/search` から `/rest/api/3/search/jql` に完全移行しました。
- `nextPageToken` を用いたページネーションにより、最大 1000 件超の課題も網羅的に取得します。
- `count_jql`・`search_jql_page` など共通ヘルパーを `lib/jira_client.py` に追加し、各 queries/ スクリプトから再利用しています。
- ボード選定処理を改善し、カンバンボードに紐づくスプリントの欠落でエラーになる問題を回避しました。

---

このドキュメントで main.py の全体像・役割・処理の流れが一目で分かります。
