<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>main() 処理フロー図 - JiraToSlack Dashboard Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', 'Yu Gothic', Meiryo, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2em;
        }
        
        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 40px;
            font-size: 1.1em;
        }
        
        .flow-section {
            margin-bottom: 40px;
        }
        
        .phase-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .phase-number {
            background: rgba(255,255,255,0.2);
            padding: 5px 12px;
            border-radius: 20px;
            margin-right: 10px;
            font-size: 0.9em;
        }
        
        .step {
            background: #f8f9fa;
            border-left: 5px solid #667eea;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .step:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }
        
        .step-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1em;
            display: flex;
            align-items: center;
        }
        
        .step-icon {
            width: 30px;
            height: 30px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-size: 0.9em;
        }
        
        .function-call {
            background: white;
            border: 2px solid #e8eaf6;
            border-radius: 6px;
            padding: 12px;
            margin: 10px 0;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
        }
        
        .func-name {
            color: #5e35b1;
            font-weight: bold;
        }
        
        .input {
            color: #00695c;
            margin-left: 20px;
        }
        
        .output {
            color: #d84315;
            margin-left: 20px;
        }
        
        .arrow {
            text-align: center;
            color: #667eea;
            font-size: 1.5em;
            margin: 10px 0;
        }
        
        .parallel-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        
        .parallel-item {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #2196f3;
        }
        
        .note {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 15px;
            margin: 15px 0;
            border-radius: 6px;
        }
        
        .note-title {
            font-weight: bold;
            color: #e65100;
            margin-bottom: 8px;
        }
        
        .data-flow {
            background: #e8f5e9;
            border: 2px dashed #4caf50;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .data-label {
            font-weight: bold;
            color: #2e7d32;
            margin-bottom: 8px;
        }
        
        .legend {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin-top: 40px;
        }
        
        .legend-title {
            font-weight: bold;
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .legend-item {
            display: inline-block;
            margin: 5px 15px 5px 0;
        }
        
        .legend-box {
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-right: 8px;
            vertical-align: middle;
            border-radius: 3px;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #1e88e5 0%, #1565c0 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔄 main() 処理フロー図</h1>
        <p class="subtitle">prototype/local_cli/main.py - スプリントダッシュボード生成フロー</p>
        
        <div class="summary-stats">
            <div class="stat-card">
                <div class="stat-number">7</div>
                <div class="stat-label">主要フェーズ</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">15+</div>
                <div class="stat-label">外部クエリ実行</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">3</div>
                <div class="stat-label">出力ファイル</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">AI</div>
                <div class="stat-label">Gemini統合</div>
            </div>
        </div>

        <!-- Phase 1: 環境準備 -->
        <div class="flow-section">
            <div class="phase-header">
                <span class="phase-number">Phase 1</span>
                環境と認証の準備
            </div>
            
            <div class="step">
                <div class="step-title">
                    <span class="step-icon">1</span>
                    環境変数の読み込み
                </div>
                <div class="function-call">
                    <span class="func-name">ensure_env_loaded()</span>
                    <div class="input">📥 入力: なし（.envファイルを複数パスから探索）</div>
                    <div class="output">📤 出力: bool（読み込み成功/失敗）</div>
                </div>
                <div class="note">
                    <div class="note-title">💡 処理内容</div>
                    候補パス（local_cli/.env, queries/.env, cwd/.env, repo_root/.env）から.envを読み込み、os.environに反映。
                </div>
            </div>

            <div class="arrow">⬇️</div>

            <div class="step">
                <div class="step-title">
                    <span class="step-icon">2</span>
                    Jira認証情報の取得
                </div>
                <div class="data-flow">
                    <div class="data-label">🔑 取得する環境変数</div>
                    <ul>
                        <li>JIRA_DOMAIN（エンドポイント）</li>
                        <li>JIRA_EMAIL（認証メールアドレス）</li>
                        <li>JIRA_API_TOKEN（APIトークン）</li>
                    </ul>
                </div>
                <div class="function-call">
                    auth = <span class="func-name">HTTPBasicAuth</span>(email, api_token)
                </div>
            </div>
        </div>

        <!-- Phase 2: メタデータ取得 -->
        <div class="flow-section">
            <div class="phase-header">
                <span class="phase-number">Phase 2</span>
                Jira ボード・スプリント メタデータ取得
            </div>

            <div class="step">
                <div class="step-title">
                    <span class="step-icon">3</span>
                    ボード解決
                </div>
                <div class="function-call">
                    <span class="func-name">resolve_board</span>(JIRA_DOMAIN, auth)
                    <div class="input">📥 入力: ドメイン, HTTPBasicAuth</div>
                    <div class="output">📤 出力: (HTTPステータス, board辞書, エラー文字列)</div>
                </div>
                <div class="note">
                    <div class="note-title">🔍 内部処理</div>
                    <ul>
                        <li>JIRA_BOARD_IDまたはJIRA_PROJECT_KEYから適切なボードを探索</li>
                        <li>スプリント対応ボードのみを選択（Scrumボード優先）</li>
                        <li>board_selector.pyのロジックを使用</li>
                    </ul>
                </div>
            </div>

            <div class="arrow">⬇️</div>

            <div class="step">
                <div class="step-title">
                    <span class="step-icon">4</span>
                    プロジェクト・スプリント情報の収集
                </div>
                <div class="parallel-group">
                    <div class="parallel-item">
                        <strong>try_infer_project_key_from_board()</strong>
                        <div>→ プロジェクトキーを推定</div>
                    </div>
                    <div class="parallel-item">
                        <strong>count_boards_for_project()</strong>
                        <div>→ ボード総数（boards_n）</div>
                    </div>
                    <div class="parallel-item">
                        <strong>count_active_sprints_for_board()</strong>
                        <div>→ アクティブスプリント数（sprints_n）</div>
                    </div>
                    <div class="parallel-item">
                        <strong>resolve_active_sprint()</strong>
                        <div>→ スプリント詳細（name, startDate, endDate）</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Phase 3: コアデータ取得 -->
        <div class="flow-section">
            <div class="phase-header">
                <span class="phase-number">Phase 3</span>
                コアデータ取得（サブタスク一覧）
            </div>

            <div class="step">
                <div class="step-title">
                    <span class="step-icon">5</span>
                    スプリントサブタスクの取得
                </div>
                <div class="function-call">
                    <span class="func-name">get_json_from_script</span>("queries/jira_list_sprint_subtasks.py")
                    <div class="input">📥 入力: スクリプトパス, env変数（OUTPUT_JSON=1）</div>
                    <div class="output">📤 出力: data辞書（parents, totals含む）</div>
                </div>
                <div class="data-flow">
                    <div class="data-label">📊 取得データ構造</div>
                    <pre style="background: white; padding: 10px; border-radius: 4px; overflow-x: auto;">
{
  "parents": [
    {
      "key": "SCRUM-123",
      "summary": "親タスク",
      "assignee": "担当者名",
      "subtasks": [
        {
          "key": "SCRUM-124",
          "summary": "子タスク",
          "done": true,
          "assignee": "担当者名"
        }
      ]
    }
  ],
  "totals": {
    "subtasks": 100,
    "done": 75,
    "notDone": 25
  }
}</pre>
                </div>
                <div class="note">
                    <div class="note-title">⚙️ サブプロセス実行の仕組み</div>
                    <ul>
                        <li>_run_python_script() 経由でPythonスクリプトを実行</li>
                        <li>可能であればモジュール実行（-m）、失敗時は直接実行</li>
                        <li>標準出力の最終行からJSONをパース</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Phase 4: 追加メトリクス収集 -->
        <div class="flow-section">
            <div class="phase-header">
                <span class="phase-number">Phase 4</span>
                追加メトリクス収集（extras辞書に格納）
            </div>

            <div class="step">
                <div class="step-title">
                    <span class="step-icon">6</span>
                    並列クエリ実行
                </div>
                <div class="note">
                    <div class="note-title">📌 すべてのクエリは try-except で保護され、失敗時も処理継続</div>
                </div>
                
                <div class="parallel-group">
                    <div class="parallel-item">
                        <strong>A. Burndown</strong>
                        <div style="margin-top: 8px;">
                            <code>jira_q_burndown.py --unit {BURNDOWN_UNIT}</code>
                        </div>
                        <div style="margin-top: 5px; font-size: 0.9em;">
                            → extras["burndown"]
                        </div>
                    </div>

                    <div class="parallel-item">
                        <strong>B. Velocity</strong>
                        <div style="margin-top: 8px;">
                            <code>jira_q_velocity_history.py --n {N_SPRINTS}</code>
                        </div>
                        <div style="margin-top: 5px; font-size: 0.9em;">
                            → extras["velocity"]
                        </div>
                    </div>

                    <div class="parallel-item">
                        <strong>B2. Project Sprint Count</strong>
                        <div style="margin-top: 8px;">
                            <code>jira_count_project_sprints.py</code>
                        </div>
                        <div style="margin-top: 5px; font-size: 0.9em;">
                            → extras["project_sprint_count"]
                        </div>
                    </div>

                    <div class="parallel-item">
                        <strong>C. Status Distribution</strong>
                        <div style="margin-top: 8px;">
                            <code>jira_q_status_counts.py --scope sprint --mode approx</code>
                        </div>
                        <div style="margin-top: 5px; font-size: 0.9em;">
                            → extras["status_counts"]
                        </div>
                    </div>

                    <div class="parallel-item">
                        <strong>D. Time-in-Status</strong>
                        <div style="margin-top: 8px;">
                            <code>jira_q_time_in_status.py --scope sprint --unit days</code>
                        </div>
                        <div style="margin-top: 5px; font-size: 0.9em;">
                            → extras["time_in_status"]
                        </div>
                    </div>

                    <div class="parallel-item">
                        <strong>E. Assignee Workload</strong>
                        <div style="margin-top: 8px;">
                            <code>jira_q_assignee_workload.py --scope sprint</code>
                        </div>
                        <div style="margin-top: 5px; font-size: 0.9em;">
                            → extras["workload"]
                        </div>
                    </div>
                </div>
            </div>

            <div class="arrow">⬇️</div>

            <div class="step">
                <div class="step-title">
                    <span class="step-icon">7</span>
                    KPIとリスク指標の計算
                </div>
                <div class="parallel-group">
                    <div class="parallel-item">
                        <strong>F1. Overdue Count</strong>
                        <div style="margin-top: 8px;">
                            <code>jira_q_overdue_count.py --scope sprint</code>
                        </div>
                        <div style="margin-top: 5px;">
                            → risks["overdue"]
                        </div>
                    </div>

                    <div class="parallel-item">
                        <strong>F2. Due Soon Count</strong>
                        <div style="margin-top: 8px;">
                            <code>jira_q_due_soon_count.py --scope sprint --days 7</code>
                        </div>
                        <div style="margin-top: 5px;">
                            → risks["dueSoon"]
                        </div>
                    </div>

                    <div class="parallel-item">
                        <strong>F3. High Priority Unstarted</strong>
                        <div style="margin-top: 8px;">
                            JQL: priority in (Highest,High) AND status="To Do"
                        </div>
                        <div style="margin-top: 5px;">
                            → risks["highPriorityTodo"]
                        </div>
                    </div>

                    <div class="parallel-item">
                        <strong>F4. Unassigned Count</strong>
                        <div style="margin-top: 8px;">
                            <code>jira_q_unassigned_count.py --scope sprint</code>
                        </div>
                        <div style="margin-top: 5px;">
                            → kpis["unassignedCount"]
                        </div>
                    </div>

                    <div class="parallel-item">
                        <strong>F5. Project Subtask Count</strong>
                        <div style="margin-top: 8px;">
                            <code>jira_count_project_subtasks.py</code>
                        </div>
                        <div style="margin-top: 5px;">
                            → kpis["projectTotal"], kpis["projectOpenTotal"]
                        </div>
                    </div>
                </div>

                <div class="data-flow" style="margin-top: 20px;">
                    <div class="data-label">📈 統合されるKPI辞書</div>
                    <pre style="background: white; padding: 10px; border-radius: 4px;">
kpis = {
  "projectTotal": プロジェクト全小タスク数,
  "projectOpenTotal": プロジェクト未完了タスク数,
  "sprintTotal": スプリント全小タスク数,
  "sprintOpen": スプリント未完了タスク数,
  "sprintDone": スプリント完了タスク数,
  "unassignedCount": 担当者未定タスク数,
  "overdue": 期限超過タスク数,
  "dueSoon": 期限接近タスク数（7日以内）,
  "highPriorityTodo": 高優先度未着手タスク数
}

risks = {
  "overdue": 期限超過,
  "dueSoon": 期限接近,
  "highPriorityTodo": 高優先度未着手
}</pre>
                </div>

                <div class="note">
                    <div class="note-title">🔄 データソースの優先順位</div>
                    <ul>
                        <li>sprintTotal/sprintDone: data["totals"]から取得（サブタスクベース）</li>
                        <li>projectTotal: 専用スクリプト（jira_count_project_subtasks.py）優先、失敗時はJQLでフォールバック</li>
                        <li>risks指標: サブタスク限定JQLで再計算し、正確性を担保</li>
                    </ul>
                </div>
            </div>

            <div class="arrow">⬇️</div>

            <div class="step">
                <div class="step-title">
                    <span class="step-icon">8</span>
                    エビデンステーブルの生成
                </div>
                <div class="function-call">
                    <span class="func-name">G. Evidence Generation</span>
                    <div class="input">📥 入力: extras["time_in_status"]からtop N課題を抽出</div>
                    <div class="output">📤 出力: extras["evidence"] = [課題辞書...]</div>
                </div>
                <div class="note">
                    <div class="note-title">📋 処理ステップ</div>
                    <ol style="margin-left: 20px;">
                        <li>time_in_statusから全課題の滞在時間を合計</li>
                        <li>日数降順でソート、top N（既定5件）を抽出</li>
                        <li>JQLで該当課題の詳細（status, assignee, priority, duedate）を取得</li>
                        <li>ヒューリスティックで"why"（重要な理由）を判定
                            <ul style="margin-left: 20px;">
                                <li>期限超過 → "overdue"</li>
                                <li>7日以内期限 → "due soon"</li>
                                <li>高優先度 → "high priority"</li>
                                <li>5日以上滞留 → "long stay"</li>
                            </ul>
                        </li>
                        <li>オプション: Geminiで"why"を自然言語で上書き</li>
                    </ol>
                </div>
                <div class="function-call" style="margin-top: 15px;">
                    <span class="func-name">maybe_gemini_justify_evidences</span>(api_key, evidence_list)
                    <div class="input">📥 入力: Gemini APIキー, エビデンス配列</div>
                    <div class="output">📤 出力: {課題キー: AI生成理由文} 辞書</div>
                </div>
            </div>
        </div>

        <!-- Phase 5: AI要約生成 -->
        <div class="flow-section">
            <div class="phase-header">
                <span class="phase-number">Phase 5</span>
                AI要約生成（Gemini統合）
            </div>

            <div class="step">
                <div class="step-title">
                    <span class="step-icon">9</span>
                    コンテキスト構築とGemini呼び出し
                </div>
                <div class="data-flow">
                    <div class="data-label">🤖 AI要約用コンテキスト</div>
                    <pre style="background: white; padding: 10px; border-radius: 4px; overflow-x: auto;">
context_for_ai = {
  "sprint_label": スプリント名と期間,
  "sprint_total": 全小タスク数,
  "sprint_done": 完了小タスク数,
  "done_percent": 完了率,
  "target_percent": 目標完了率,
  "remaining_days": 残日数,
  "required_daily_burn": 必要日次消化数,
  "actual_daily_burn": 実績日次消化数（直近3日平均）,
  "sprint_open": スプリント未完了数,
  "backlog_open": バックログ未完了数,
  "velocity_avg": 平均ベロシティ,
  "last_velocity": 最新ベロシティ,
  "bottleneck_status": ボトルネック工程名,
  "bottleneck_days": ボトルネック工程平均滞在日数,
  "review_avg_days": レビュー工程平均日数,
  "overdue": 期限超過件数,
  "due_soon": 期限接近件数,
  "high_priority_unstarted": 高優先度未着手件数,
  "suggested_actions": [アクション候補リスト],
  "top_evidence": [エビデンス配列],
  "project_open_total": プロジェクト全体未完了数
}</pre>
                </div>

                <div class="function-call" style="margin-top: 15px;">
                    <span class="func-name">maybe_gemini_summary</span>(api_key, context_for_ai)
                    <div class="input">📥 入力: Gemini APIキー（サニタイズ済）, コンテキスト辞書</div>
                    <div class="output">📤 出力: AI生成要約テキスト（フォーマット指定あり）</div>
                </div>

                <div class="note">
                    <div class="note-title">⚙️ Gemini設定</div>
                    <ul>
                        <li>モデル: GEMINI_MODEL（既定 gemini-2.5-flash-lite）</li>
                        <li>温度: GEMINI_TEMPERATURE（既定 0.1）</li>
                        <li>Top-P: GEMINI_TOP_P（既定 0.9）</li>
                        <li>最大トークン: 640</li>
                        <li>タイムアウト: GEMINI_TIMEOUT（既定 30秒）</li>
                        <li>リトライ: GEMINI_RETRIES（既定 2回）</li>
                        <li>トランスポート: REST（gRPCメタデータ問題回避）</li>
                    </ul>
                </div>

                <div class="note" style="background: #ffe0b2; border-left-color: #f57c00;">
                    <div class="note-title" style="color: #e65100;">🔐 APIキーのサニタイズ</div>
                    _sanitize_api_key() で不要な記号・コメントを除去し、'AIza'以降の有効部分のみ抽出
                </div>

                <div class="data-flow" style="margin-top: 15px;">
                    <div class="data-label">📝 出力フォーマット（プロンプトで指定）</div>
                    <pre style="background: white; padding: 10px; border-radius: 4px;">
## 🎯 結論（1行断言）
完了率[X%] - [順調✅/注意⚠️/危険🚨] 残[Y]日で目標[Z%]（[理由5字以内]）

## 🚨 即実行アクション（重要順3つ）
1. [担当者] → [タスク] （[期限]）
2. [担当者] → [タスク] （[期限]）
3. [担当者] → [タスク] （[期限]）

## 📊 根拠（2行以内）
• データ: 完了[X]/全[Y]件、必要消化[Z]件/日（実績[W]件/日）
• 問題: [ボトルネック] + [リスク] = 目標未達リスク[%]</pre>
                </div>
            </div>
        </div>

        <!-- Phase 6: ダッシュボード描画 -->
        <div class="flow-section">
            <div class="phase-header">
                <span class="phase-number">Phase 6</span>
                ダッシュボード画像生成
            </div>

            <div class="step">
                <div class="step-title">
                    <span class="step-icon">10</span>
                    PNG描画処理
                </div>
                <div class="function-call">
                    <span class="func-name">draw_png</span>(
                        output_path,
                        data,
                        boards_n,
                        sprints_n,
                        sprint_name,
                        sprint_start,
                        sprint_end,
                        axis_mode,
                        target_done_rate,
                        extras
                    )
                    <div class="input">📥 入力: 
                        <ul style="margin-left: 20px; margin-top: 5px;">
                            <li>output_path: PNG保存先</li>
                            <li>data: サブタスク集計データ</li>
                            <li>boards_n, sprints_n: 表示用カウント</li>
                            <li>sprint_name, sprint_start, sprint_end: スプリント情報</li>
                            <li>axis_mode: "percent" or "count"</li>
                            <li>target_done_rate: 目標達成率（既定0.8）</li>
                            <li>extras: 全メトリクス・AI要約を含む辞書</li>
                        </ul>
                    </div>
                    <div class="output">📤 出力: PNG画像ファイル（1400x980px）を保存</div>
                </div>

                <div class="note">
                    <div class="note-title">🎨 描画内容</div>
                    <ul>
                        <li><strong>ヘッダー左:</strong> プロジェクト/ボード/スプリント/タスクの階層バー</li>
                        <li><strong>ヘッダー右:</strong> バーンダウングラフ（予測線付き）+ ミニベロシティチャート + KPI</li>
                        <li><strong>中央:</strong> タスク完了率サマリーバー（Done/Not Done）+ 目標ベンチマーク線</li>
                        <li><strong>左カラム:</strong> Velocityバー + ステータス分布 + Time-in-Status ヒートマップ</li>
                        <li><strong>右カラム:</strong> KPIカード（6枚）+ 担当者別ワークロード</li>
                        <li><strong>下部:</strong> エビデンステーブル（Top N）</li>
                        <li><strong>キャプション:</strong> What/So what/Next action（データ出典明記）</li>
                        <li><strong>オーバーレイ:</strong> AI要約パネル（折り返し表示、長文対応）</li>
                        <li><strong>フッター:</strong> 生成日時タイムスタンプ</li>
                    </ul>
                </div>

                <div class="note" style="background: #f3e5f5; border-left-color: #9c27b0;">
                    <div class="note-title" style="color: #6a1b9a;">🖼️ 画像生成の技術詳細</div>
                    <ul>
                        <li>Pillow (PIL) でキャンバス作成・描画</li>
                        <li>カラーブラインドフレンドリーな配色</li>
                        <li>日本語フォント優先ロード（Meiryo, Yu Gothic等）</li>
                        <li>テキスト幅フィッティング機能</li>
                        <li>バーンダウン予測：線形回帰で完了日推定</li>
                        <li>AI要約: 折り返し表示、最大行数制限</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Phase 7: 追加出力 -->
        <div class="flow-section">
            <div class="phase-header">
                <span class="phase-number">Phase 7</span>
                追加ファイル出力とログ
            </div>

            <div class="step">
                <div class="step-title">
                    <span class="step-icon">11</span>
                    Markdownレポート生成
                </div>
                <div class="data-flow">
                    <div class="data-label">📄 sprint_overview_report.md</div>
                    <ul>
                        <li>要約（What/So what/Next action）</li>
                        <li>AI要約全文（Gemini生成）</li>
                        <li>リスク一覧（期限超過・接近・高優先度未着手の課題キー）</li>
                        <li>エビデンステーブル（Top N課題の詳細）</li>
                        <li>短期アクション提案</li>
                    </ul>
                </div>
            </div>

            <div class="arrow">⬇️</div>

            <div class="step">
                <div class="step-title">
                    <span class="step-icon">12</span>
                    構造化データ出力
                </div>
                <div class="parallel-group">
                    <div class="parallel-item">
                        <strong>sprint_overview_tasks.json</strong>
                        <div style="margin-top: 8px; font-size: 0.9em;">
                            スプリント情報 + parents/subtasks + totals
                        </div>
                    </div>
                    <div class="parallel-item">
                        <strong>sprint_overview_data.json</strong>
                        <div style="margin-top: 8px; font-size: 0.9em;">
                            メトリクス要約（Slack連携用）
                        </div>
                    </div>
                </div>
            </div>

            <div class="arrow">⬇️</div>

            <div class="step">
                <div class="step-title">
                    <span class="step-icon">13</span>
                    ログ出力とパス表示
                </div>
                <div class="note">
                    <div class="note-title">📋 ログ内容（DASHBOARD_LOG=1時）</div>
                    <ul>
                        <li>各データソースのサマリー（件数、日数、平均値等）</li>
                        <li>Gemini呼び出し結果（成功/失敗、APIキーマスク表示）</li>
                        <li>エビデンス件数とキーリスト</li>
                    </ul>
                </div>
                <div class="function-call" style="margin-top: 10px;">
                    print(<span style="color: #00695c;">out_path</span>)  # 最終的にPNGパスをコンソール出力
                </div>
                <div class="output" style="margin-left: 0; margin-top: 10px;">
                    📤 戻り値: 0（正常終了）
                </div>
            </div>
        </div>

        <!-- Legend -->
        <div class="legend">
            <div class="legend-title">📚 凡例</div>
            <div class="legend-item">
                <span class="legend-box" style="background: #667eea;"></span>
                メインフェーズ
            </div>
            <div class="legend-item">
                <span class="legend-box" style="background: #e3f2fd; border: 2px solid #2196f3;"></span>
                並列処理
            </div>
            <div class="legend-item">
                <span class="legend-box" style="background: #fff3e0; border-left: 4px solid #ff9800;"></span>
                注記・詳細
            </div>
            <div class="legend-item">
                <span class="legend-box" style="background: #e8f5e9; border: 2px dashed #4caf50;"></span>
                データフロー
            </div>
            <div class="legend-item">
                <span class="legend-box" style="background: white; border: 2px solid #e8eaf6;"></span>
                関数呼び出し
            </div>
        </div>

        <div class="note" style="margin-top: 40px; background: #e1f5fe; border-left-color: #0288d1;">
            <div class="note-title" style="color: #01579b;">💡 エラーハンドリング戦略</div>
            <ul>
                <li>Phase 4以降の各クエリは独立したtry-exceptで保護され、失敗してもNoneを格納して処理継続</li>
                <li>Gemini呼び出しは環境変数（GEMINI_DISABLE）で無効化可能</li>
                <li>APIキーが不正な場合はサニタイズ後に再試行、最終的に空要約で継続</li>
                <li>画像描画で例外が起きてもファイル出力まで到達し、部分的な結果を保存</li>
            </ul>
        </div>

        <div style="text-align: center; margin-top: 40px; padding: 20px; background: #f5f5f5; border-radius: 8px;">
            <p style="color: #7f8c8d; font-size: 0.9em;">
                生成日時: 2025年10月2日<br>
                対象ファイル: prototype/local_cli/main.py (2655行)<br>
                フロー図バージョン: 1.0
            </p>
        </div>
    </div>
</body>
</html>
